from os import system
import os
import subprocess
import time
import sys
from tkinter import E

print("usage:python3 xray_webscan.py <target file path>")
url_filepath = sys.argv[1]
filename = url_filepath.split("/")[-1]  # 得到文件的名字
targetname = filename.split(".txt")[0]  # 得到资产名字
if os.path.exists(targetname):
    print(targetname," dir has existed,please check")
    exit(0)
os.mkdir(targetname) #以targetname去创建文件夹
print("[Attention]mkdir ",targetname," ok!")
with open(url_filepath, "r") as f:
    url_list = f.readlines()
url_list = list(url_list)
url_scanned=[]
for url in url_list:
    # webscan必须指定一个服务及端口进行扫描才可以，只输入域名是不行的
    url=url.replace("\n","")
    timecount=0
    if url not in url_scanned:
        url_scanned.append(url)
        print("[",time.strftime('%Y-%m-%d %H:%M:%S', time.localtime()),"] ",url," Webscan start")
        # subprocess 模块允许我们启动一个新进程，并连接到它们的输入/输出/错误管道，从而获取返回值
        ret= subprocess.run(['./xray', 'webscan', '--basic-crawler', url, '--html-output', targetname + "/"+url.split("://")[1]+".html"],
                            stdout=subprocess.PIPE, stderr=subprocess.PIPE, encoding="utf-8", timeout=600)
        if ret.returncode == 0:
            print("[",time.strftime('%Y-%m-%d %H:%M:%S', time.localtime()),"][SUCCESS] scanned end")
        else:
            print("[",time.strftime('%Y-%m-%d %H:%M:%S', time.localtime()),"][ERROR] time out")
print("[",time.strftime('%Y-%m-%d %H:%M:%S', time.localtime()),"] Process end")
